<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brighton Player Daily - Mockup</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #212121;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .material-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            transition: box-shadow 0.3s ease;
        }

        .material-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #1976d2;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #1565c0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #212121;
        }
        .btn-secondary:hover {
            background-color: #d5d5d5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(224, 224, 224, 0.3);
        }

        .btn-gemini {
            background: linear-gradient(45deg, #1976d2, #2196f3);
            color: #ffffff;
        }
        .btn-gemini:hover {
            background: linear-gradient(45deg, #1565c0, #1e88e5);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-disabled {
            background-color: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .letter-input {
            width: 40px;
            height: 40px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #ffffff;
            font-size: 1.25rem;
            font-weight: 500;
            color: #212121;
            transition: all 0.3s ease;
        }

        .letter-input:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
            outline: none;
        }

        .letter-input.correct {
            border-color: #4caf50;
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .letter-input.revealed {
            border-color: #ffb300;
            background-color: #fff8e1;
            color: #e65100;
            font-weight: 600;
        }

        .letter-input.prefilled {
            border-color: #bdbdbd;
            background-color: #eeeeee;
            color: #616161;
            font-weight: 600;
            cursor: default;
        }

        .btn-reveal {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #ffffff;
            font-weight: 500;
        }
        .btn-reveal:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffb300, #fb8c00);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-reveal:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
        }

        @keyframes clue-reveal {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .clue-new {
            animation: clue-reveal 0.3s ease-out;
        }

        .header {
            background-color: #1976d2;
            color: #ffffff;
            padding: 12px 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (min-width: 640px) {
            .header {
                padding: 16px;
            }
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.9;
            margin: 4px 0 0 0;
        }

        .star {
            color: #ffc107;
            font-size: 1.25rem;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            max-width: 400px;
            width: 90%;
        }

        .countdown-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .countdown-timer .time-unit {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 1.25rem;
            min-width: 48px;
            text-align: center;
        }

        .countdown-timer .time-separator {
            color: #1976d2;
            font-weight: 600;
            font-size: 1.25rem;
            line-height: 1;
        }

        .bio-container {
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 16px;
            margin-top: 16px;
        }

        .spinner {
            border: 3px solid rgba(25, 118, 210, 0.2);
            border-top-color: #1976d2;
        }

        .stats-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-title {
            color: #1976d2;
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .stats-value {
            font-size: 2rem;
            font-weight: 500;
            color: #212121;
        }

        .stats-label {
            color: #757575;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="header">
        <div class="container mx-auto px-4 flex flex-col items-center justify-center">
            <h1 class="flex items-center gap-2 justify-center w-full text-center">
                <span class="material-icons">sports_soccer</span>
                Brighton Player Daily
                <svg width="24" height="24" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle"><path d="M8 36 C 20 20, 26 20, 32 30 C 38 20, 44 20, 56 36" stroke="white" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </h1>
            <p class="text-center">Guess today's mystery Seagull! (Since 2002/03 season)</p>
        </div>
        <button id="change-player-btn" style="display:none; position: fixed; top: 16px; right: 16px; z-index: 1000;" class="btn btn-primary p-2 min-w-0 w-10 h-10 flex items-center justify-center">
            <span class="material-icons">refresh</span>
        </button>
    </header>

    <main class="flex-grow container mx-auto px-4 py-4 sm:py-8">
        <div id="app-container" class="max-w-lg mx-auto">
            <div id="welcome-view" class="material-card p-6 space-y-6 text-center hidden">
                <div class="flex flex-col items-center gap-2">
                    <span class="material-icons text-blue-600" style="font-size: 3rem;">sports_soccer</span>
                    <h2 class="text-2xl font-medium text-blue-700">Welcome Back!</h2>
                </div>
                <div id="streak-display" class="py-4">
                    <p id="streak-value" class="text-4xl font-bold text-amber-500">0 üî•</p>
                    <p id="streak-label" class="text-gray-600 mt-1">Day Streak</p>
                </div>
                <button id="play-btn" class="btn btn-primary w-full text-lg py-4">
                    <span class="material-icons">play_arrow</span>
                    Play Today's Challenge
                </button>
            </div>

            <div id="game-view" class="material-card p-4 sm:p-6 space-y-3 sm:space-y-6 hidden">
                <div>
                    <p class="text-center text-sm text-gray-600 mb-1">Today's Mystery Player:</p>
                    <p id="name-length-hint" class="text-center text-xs text-gray-400 mb-3 hidden"></p>
                    <div id="player-name-input-area" class="letter-input-container">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>

                <div id="clue-section" class="bg-blue-50 p-3 sm:p-4 rounded-lg border border-blue-100">
                    <div id="clues-list"></div>
                </div>

                <div class="text-center">
                    <p class="text-lg font-medium">Guess now for <span id="star-potential" class="font-bold text-amber-500">5 <span class="star">‚≠ê</span></span></p>
                </div>

                <div id="feedback-message" class="text-center p-2 sm:p-3 rounded-md min-h-[40px]"></div>

                <button id="gemini-clue-btn" class="btn btn-gemini w-full mt-0 hidden">
                    <span class="material-icons">lightbulb</span>
                    Get Cryptic Clue (Lose 2 ‚≠ê)
                </button>
                <div id="game-buttons" class="space-y-3 mt-2">
                    <button id="submit-guess-btn" class="btn btn-primary w-full">
                        <span class="material-icons">check</span>
                        Submit Guess
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="reveal-letter-btn" class="btn btn-reveal w-full flex items-center justify-center gap-1 text-sm px-2 py-3" disabled>
                            <span class="material-icons" style="font-size:18px">lightbulb</span> Reveal Letter (-1 ‚≠ê)
                        </button>
                        <button id="next-clue-btn" class="btn btn-secondary w-full flex items-center justify-center gap-1 text-sm px-2 py-3" disabled>
                            <span class="material-icons" style="font-size:18px">arrow_forward</span> Next Clue (4 <span class="star">‚≠ê</span>)
                        </button>
                    </div>
                </div>
            </div>

            <div id="results-view" class="material-card p-6 space-y-6 text-center hidden">
                <h2 id="results-title" class="text-2xl sm:text-3xl font-medium text-blue-700">Congratulations!</h2>
                <div id="results-player-name-display" class="letter-input-container my-4"></div>
                <p id="results-player-name-text" class="text-xl text-blue-600">You guessed: <span class="font-medium"></span></p>

                <div>
                    <div id="stars-earned-display" class="flex justify-center my-2 space-x-1 items-baseline"></div>
                    <p id="clues-used-display" class="text-gray-600"></p>
                </div>
                
                <button id="generate-bio-btn" class="btn btn-gemini w-full">
                    <span class="material-icons">auto_awesome</span>
                    Generate Player Bio
                </button>
                <div id="bio-container" class="bio-container hidden">
                    <div id="bio-loading" class="flex items-center justify-center">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-600">Generating bio...</p>
                    </div>
                    <p id="bio-content" class="text-gray-800"></p>
                </div>

                <button id="share-results-btn" class="btn btn-primary w-full sm:w-auto mt-4">
                    <span class="material-icons">share</span>
                    Share Results
                </button>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-gray-600 mb-2">Next player in:</p>
                    <div id="countdown-timer" class="countdown-timer">
                        <span id="hours" class="time-unit">10</span>
                        <span class="time-separator">:</span>
                        <span id="minutes" class="time-unit">23</span>
                        <span class="time-separator">:</span>
                        <span id="seconds" class="time-unit">45</span>
                    </div>
                </div>
            </div>

            <div id="stats-view" class="material-card p-6 space-y-4 hidden">
                <h2 class="text-2xl font-medium text-blue-700 mb-4 text-center">Your Statistics</h2>
                
                <div class="stats-card">
                    <h3 class="stats-title">Star Distribution</h3>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <span class="w-8 text-blue-600">5 ‚≠ê</span>
                            <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="star-5-bar" class="h-full bg-amber-400 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="star-5-count" class="w-12 text-right text-blue-600">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-8 text-blue-600">4 ‚≠ê</span>
                            <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="star-4-bar" class="h-full bg-amber-400 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="star-4-count" class="w-12 text-right text-blue-600">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-8 text-blue-600">3 ‚≠ê</span>
                            <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="star-3-bar" class="h-full bg-amber-400 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="star-3-count" class="w-12 text-right text-blue-600">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-8 text-blue-600">2 ‚≠ê</span>
                            <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="star-2-bar" class="h-full bg-amber-400 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="star-2-count" class="w-12 text-right text-blue-600">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-8 text-blue-600">1 ‚≠ê</span>
                            <div class="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="star-1-bar" class="h-full bg-amber-400 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="star-1-count" class="w-12 text-right text-blue-600">0</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="stats-card">
                        <p class="stats-value" id="total-stars-stat">0 ‚≠ê</p>
                        <p class="stats-label">Total Stars</p>
                    </div>
                    <div class="stats-card">
                        <p class="stats-value" id="games-played-stat">0</p>
                        <p class="stats-label">Games Played</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="stats-card">
                        <p class="stats-value" id="current-streak-stat">0 üî•</p>
                        <p class="stats-label">Current Streak</p>
                    </div>
                    <div class="stats-card">
                        <p class="stats-value" id="longest-streak-stat">0 üî•</p>
                        <p class="stats-label">Best Streak</p>
                    </div>
                </div>
                <button id="back-to-game-btn-stats" class="btn btn-secondary w-full mt-6">
                    <span class="material-icons">arrow_back</span>
                    Back to Game
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-white py-4 mt-8 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center">
            <button id="view-stats-btn" class="btn btn-secondary">
                <span class="material-icons">bar_chart</span>
                View Stats
            </button>
        </div>
    </footer>

    <!-- Share Modal -->
    <div id="share-modal" class="modal-overlay hidden">
        <div class="modal-content p-6">
            <h3 class="text-xl font-medium text-blue-700 mb-4">Share Your Score!</h3>
            <div id="share-text-display" class="bg-gray-100 p-4 rounded-lg text-center text-gray-700 mb-6">
                Brighton Player Daily - 3/5 ‚≠ê<br>June 2, 2025
            </div>
            <div class="space-y-3">
                <button id="copy-to-clipboard-btn" class="btn btn-primary w-full">
                    <span class="material-icons">content_copy</span>
                    Copy to Clipboard
                </button>
                <p id="copy-feedback" class="text-sm text-green-600 text-center h-5"></p>
                <div class="grid grid-cols-2 gap-3">
                    <a href="#" target="_blank" class="btn bg-[#1DA1F2] text-white hover:bg-[#1a8cd8] w-full">
                        <span class="material-icons">share</span>
                        Twitter/X
                    </a>
                    <a href="#" target="_blank" class="btn bg-[#25D366] text-white hover:bg-[#22c35e] w-full">
                        <span class="material-icons">chat</span>
                        WhatsApp
                    </a>
                </div>
            </div>
            <button id="close-share-modal-btn" class="btn btn-secondary w-full mt-6">
                <span class="material-icons">close</span>
                Close
            </button>
        </div>
    </div>

    <script>
        const STATS_KEY = 'brighton_player_daily_stats';
        const GAME_STATE_KEY = 'brighton_player_daily_game_state';

        initializeStats();
        let isLocal = false;
        fetch('/api/config')
          .then(res => res.json())
          .then(cfg => {
            isLocal = !!cfg.isLocal;
            if (isLocal) {
              document.getElementById('change-player-btn').style.display = 'block';
            }
          });

        // --- DOM Elements ---
        const gameView = document.getElementById('game-view');
    const resultsView = document.getElementById('results-view');
    const playerNameInputArea = document.getElementById('player-name-input-area');
    const clueTextEl = document.getElementById('clue-text');
    const clueNumberEl = document.getElementById('clue-number');
    const starPotentialEl = document.getElementById('star-potential');
    const feedbackMessageEl = document.getElementById('feedback-message');
    const submitGuessBtn = document.getElementById('submit-guess-btn');
    const nextClueBtn = document.getElementById('next-clue-btn');
    const gameButtonsContainer = document.getElementById('game-buttons');
    const resultsTitle = document.getElementById('results-title');
    const resultsPlayerNameText = document.getElementById('results-player-name-text').querySelector('span');
    const starsEarnedDisplay = document.getElementById('stars-earned-display');
    const cluesUsedDisplay = document.getElementById('clues-used-display');
    
            // Gemini Feature Elements
    const generateBioBtn = document.getElementById('generate-bio-btn');
    const bioContainer = document.getElementById('bio-container');
    const bioLoading = document.getElementById('bio-loading');
    const bioContent = document.getElementById('bio-content');
    let geminiClueBtn = null;
        
        // --- Game State ---
        let currentChallenge = {};
        let letterInputs = [];
        let currentClueIndex = 0;
        let gameEnded = false;
        let geminiClueUsed = false;
        let crypticClueText = '';
        let revealedClues = [];
        let revealedLetterPositions = []; // indices into letterInputs[] for revealed letters

        // --- Game State Persistence ---
        function saveGameState() {
            const letterValues = letterInputs.map(input => input.value);
            const state = {
                date: new Date().toISOString().split('T')[0],
                currentChallenge,
                currentClueIndex,
                revealedClues,
                revealedLetterPositions,
                geminiClueUsed,
                crypticClueText,
                letterValues
            };
            localStorage.setItem(GAME_STATE_KEY, JSON.stringify(state));
        }

        function loadGameState() {
            try {
                const saved = localStorage.getItem(GAME_STATE_KEY);
                if (!saved) return null;
                const state = JSON.parse(saved);
                const today = new Date().toISOString().split('T')[0];
                if (state.date !== today) {
                    localStorage.removeItem(GAME_STATE_KEY);
                    return null;
                }
                return state;
            } catch { return null; }
        }

        function clearGameState() {
            localStorage.removeItem(GAME_STATE_KEY);
        }

        function restoreGame(state) {
            currentChallenge = state.currentChallenge;
            currentClueIndex = state.currentClueIndex;
            revealedClues = state.revealedClues;
            revealedLetterPositions = state.revealedLetterPositions || [];
            geminiClueUsed = state.geminiClueUsed;
            crypticClueText = state.crypticClueText;
            gameEnded = false;

            generateNameInputs(currentChallenge.firstNameLength, currentChallenge.lastNameLength);

            // Restore typed letters (after generateNameInputs which handles prefilled chars)
            if (state.letterValues) {
                state.letterValues.forEach((val, i) => {
                    if (i < letterInputs.length && val && !letterInputs[i].classList.contains('prefilled')) {
                        letterInputs[i].value = val;
                    }
                });
            }

            // Restore revealed letter styling
            revealedLetterPositions.forEach(pos => {
                if (pos < letterInputs.length) {
                    letterInputs[pos].classList.add('revealed');
                    letterInputs[pos].readOnly = true;
                }
            });

            const hintEl = document.getElementById('name-length-hint');
            if (currentChallenge.lastNameLength > 0) {
                hintEl.textContent = `${currentChallenge.firstNameLength} letters, ${currentChallenge.lastNameLength} letters`;
            } else {
                hintEl.textContent = `${currentChallenge.firstNameLength} letters`;
            }
            hintEl.classList.remove('hidden');

            renderCluesList();
            updateStarPotential();
            updateNextClueButton();
            updateRevealButton();

            gameView.classList.remove('hidden');
            resultsView.classList.add('hidden');
            submitGuessBtn.disabled = false;
            nextClueBtn.disabled = false;

            if (geminiClueUsed) {
                geminiClueBtn.classList.add('hidden');
            } else if (currentClueIndex >= 2) {
                geminiClueBtn.classList.remove('hidden');
            }
        }

        // --- API Communication ---
        // No base URL needed when frontend and backend are served from the same origin
        const API_BASE_URL = '';
    
        async function fetchDailyChallenge() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/daily-challenge`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                currentChallenge = data;
                return data;
            } catch (error) {
                console.error("Could not fetch daily challenge:", error);
                feedbackMessageEl.innerHTML = `<p class="text-red-500">Could not load today's game. Is the backend server running?</p>`;
                return null;
            }
        }
    
        async function fetchNextClue() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/clues`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: currentChallenge.player_id,
                        clue_index: currentClueIndex + 1
                    }),
                });
                const data = await response.json();
                return data.clue;
            } catch (error) {
                console.error("Could not fetch next clue:", error);
                return "Sorry, couldn't get the next clue.";
            }
        }
    
        async function submitGuess(guessFirst, guessLast) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/guess`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: currentChallenge.player_id,
                        guess_first: guessFirst,
                        guess_last: guessLast,
                    }),
                });
                return await response.json();
            } catch (error) {
                console.error("Error submitting guess:", error);
                return { correct: false };
            }
        }
    
        // --- UI & Helper Functions ---
        function createLetterInput(isFirstName, index) {
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 1;
            input.classList.add('letter-input');
            input.placeholder = 'A';
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1) {
                    const next = findNextInput(e.target);
                    if (next) next.focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '') {
                    e.preventDefault();
                    const prev = findPrevInput(e.target); if (prev) prev.focus();
                }
            });
            return input;
        }
    
        function findNextInput(current) { return letterInputs[letterInputs.indexOf(current) + 1] || null; }
        function findPrevInput(current) { return letterInputs[letterInputs.indexOf(current) - 1] || null; }
    
        function generateNameInputs(firstNameLength, lastNameLength) {
            playerNameInputArea.innerHTML = '';
            letterInputs = [];

            // Create row for both name groups
            const groupsRow = document.createElement('div');
            groupsRow.className = 'name-groups-row';

            // First Name Group
            const firstGroup = document.createElement('div');
            firstGroup.className = 'name-group';
            const firstLabel = document.createElement('div');
            firstLabel.className = 'name-label';
            firstLabel.textContent = 'First Name';
            firstGroup.appendChild(firstLabel);
            const firstLetterRow = document.createElement('div');
            firstLetterRow.className = 'letter-group-row';
            for (let i = 0; i < firstNameLength; i++) {
                const input = createLetterInput(true, i);
                firstLetterRow.appendChild(input);
                letterInputs.push(input);
            }
            firstGroup.appendChild(firstLetterRow);
            groupsRow.appendChild(firstGroup);

            // Last Name Group
            if (lastNameLength > 0) {
                const lastGroup = document.createElement('div');
                lastGroup.className = 'name-group';
                const lastLabel = document.createElement('div');
                lastLabel.className = 'name-label';
                lastLabel.textContent = 'Last Name';
                lastGroup.appendChild(lastLabel);
                const lastLetterRow = document.createElement('div');
                lastLetterRow.className = 'letter-group-row';
                for (let i = 0; i < lastNameLength; i++) {
                    const input = createLetterInput(false, i);
                    lastLetterRow.appendChild(input);
                    letterInputs.push(input);
                }
                lastGroup.appendChild(lastLetterRow);
                groupsRow.appendChild(lastGroup);
            }

            playerNameInputArea.appendChild(groupsRow);

            const totalLetters = firstNameLength + lastNameLength;
            if (totalLetters > 17) {
                groupsRow.classList.add('stacked');
            }

            // Pre-fill special characters (apostrophes, hyphens) as read-only
            const fullName = (currentChallenge.firstName || '') + (currentChallenge.lastName || '');
            letterInputs.forEach((input, i) => {
                const char = fullName[i];
                if (char && !/[a-zA-Z]/i.test(char)) {
                    input.value = char;
                    input.readOnly = true;
                    input.classList.add('prefilled');
                }
            });
        }
        
        function getGuessedName() {
            let f = "", l = "";
            const fLen = currentChallenge.firstNameLength;
            letterInputs.forEach((input, index) => {
                if (index < fLen) f += input.value;
                else l += input.value;
            });
            return { guessedFirstName: f, guessedLastName: l };
        }

        function getFullNameLetters() {
            const first = currentChallenge.firstName || '';
            const last = currentChallenge.lastName || '';
            return (first + last).split('');
        }

        function revealRandomLetter() {
            if (gameEnded) return;
            const currentStars = Math.max(6 - revealedClues.length, 1);
            if (currentStars <= 1) {
                showFeedback("Not enough stars to reveal a letter!", "error");
                return;
            }

            const fullLetters = getFullNameLetters();
            const unrevealed = [];
            letterInputs.forEach((input, i) => {
                if (revealedLetterPositions.includes(i)) return;
                if (input.classList.contains('prefilled')) return;
                if (input.value.toLowerCase() === fullLetters[i].toLowerCase()) return;
                unrevealed.push(i);
            });

            if (unrevealed.length === 0) {
                showFeedback("All letters are already filled!", "error");
                return;
            }

            const pos = unrevealed[Math.floor(Math.random() * unrevealed.length)];
            letterInputs[pos].value = fullLetters[pos].toUpperCase();
            letterInputs[pos].classList.add('revealed');
            letterInputs[pos].readOnly = true;
            revealedLetterPositions.push(pos);

            revealedClues.push("Letter reveal penalty");
            updateStarPotential();
            updateRevealButton();
            updateNextClueButton();
            saveGameState();
        }

        function updateRevealButton() {
            const revealBtn = document.getElementById('reveal-letter-btn');
            if (!revealBtn) return;
            const currentStars = Math.max(6 - revealedClues.length, 1);
            const fullLetters = getFullNameLetters();
            const hasUnrevealed = letterInputs.some((input, i) =>
                !revealedLetterPositions.includes(i) &&
                !input.classList.contains('prefilled') &&
                input.value.toLowerCase() !== fullLetters[i].toLowerCase()
            );

            if (currentStars <= 1 || gameEnded || !hasUnrevealed) {
                revealBtn.disabled = true;
            } else {
                revealBtn.disabled = false;
            }
        }

        function updateStarPotential() {
            // 5 stars for 1 clue, 4 for 2 clues, ..., 1 for 5 clues
            const stars = Math.max(6 - revealedClues.length, 1);
            starPotentialEl.innerHTML = `${stars} <span class="star">‚≠ê</span>`;
        }
    
        let feedbackTimer = null;
        function showFeedback(message, type, autoClear = true) {
            if (feedbackTimer) clearTimeout(feedbackTimer);
            feedbackMessageEl.textContent = message;
            if (autoClear) {
                feedbackTimer = setTimeout(() => { feedbackMessageEl.textContent = ''; }, 3000);
            }
        }
        
        function correctGuess(fullName) {
            gameEnded = true;
            clearGameState();
            const starsEarned = Math.max(6 - revealedClues.length, 1);
            saveGameResult(starsEarned, isLocal);
            showFeedback(`Correct! It was ${fullName}`, "success", false);
            displayResults(true, fullName, starsEarned, currentClueIndex + 1);
        }
        
        function incorrectGuess() {
            showFeedback("Incorrect Guess. Try again or get the next clue.", "error");
            letterInputs.forEach(input => {
                if (!input.classList.contains('revealed') && !input.classList.contains('prefilled')) input.value = '';
            });
            const firstEditable = letterInputs.find(input => !input.classList.contains('revealed') && !input.classList.contains('prefilled'));
            if (firstEditable) firstEditable.focus();
        }
    
        function displayResults(isSuccess, fullName, starsEarned = null, cluesUsed = null) {
            gameView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            // Update the title and label based on win/loss
            if (isSuccess) {
                resultsTitle.textContent = 'Congratulations!';
                document.getElementById('results-player-name-text').innerHTML = 'You guessed: <span class="font-medium">' + fullName + '</span>';
            } else {
                resultsTitle.textContent = 'Better luck next time!';
                document.getElementById('results-player-name-text').innerHTML = 'The player was: <span class="font-medium">' + fullName + '</span>';
            }

            // Show stars earned (always set dynamically)
            const starsDisplay = document.getElementById('stars-earned-display');
            starsDisplay.innerHTML = '';
            const earnedText = document.createElement('div');
            if (!isSuccess) {
                earnedText.textContent = 'You earned: 0 stars';
                starsDisplay.appendChild(earnedText);
            } else if (starsEarned !== null && starsEarned > 0) {
                earnedText.textContent = `You earned: ${starsEarned} star${starsEarned > 1 ? 's' : ''}`;
                starsDisplay.appendChild(earnedText);
                for (let i = 0; i < starsEarned; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.textContent = '‚≠ê';
                    starsDisplay.appendChild(star);
                }
            }

            // Show clues used
            const cluesDisplay = document.getElementById('clues-used-display');
            if (cluesUsed !== null) {
                cluesDisplay.textContent = `Clues used: ${cluesUsed}`;
            } else {
                cluesDisplay.textContent = '';
            }
        }
    
        // --- Main Game Flow ---
        async function initializeGame() {
            gameEnded = false;
            currentClueIndex = 0;
            console.log('Initializing game...');
            const challengeData = await fetchDailyChallenge();
            if (!challengeData) {
                console.log('API call failed, not enabling Next Clue button.');
                nextClueBtn.disabled = true;
                nextClueBtn.innerHTML = '<span class="material-icons">error</span> Unable to load clues';
                return;
            }
            revealedClues = [challengeData.firstClue];
            renderCluesList();
            generateNameInputs(challengeData.firstNameLength, challengeData.lastNameLength);
            const hintEl = document.getElementById('name-length-hint');
            if (challengeData.lastNameLength > 0) {
                hintEl.textContent = `${challengeData.firstNameLength} letters, ${challengeData.lastNameLength} letters`;
            } else {
                hintEl.textContent = `${challengeData.firstNameLength} letters`;
            }
            hintEl.classList.remove('hidden');
            revealedLetterPositions = [];
            updateStarPotential();
            updateNextClueButton();
            updateRevealButton();
            nextClueBtn.disabled = false;
            console.log('Game initialized, Next Clue button enabled.');
            gameView.classList.remove('hidden');
            resultsView.classList.add('hidden');
            submitGuessBtn.disabled = false;
            saveGameState();
        }
    
        async function handleNextClue() {
            const currentStars = Math.max(6 - revealedClues.length, 1);
            if (gameEnded) return;

            // If only 1 star left, treat as "Give Up"
            if (currentStars === 1) {
                gameEnded = true;
                clearGameState();
                const fullName = (currentChallenge.firstName && currentChallenge.lastName)
                    ? `${currentChallenge.firstName} ${currentChallenge.lastName}`.trim()
                    : "Unknown Player";
                showFeedback(`The answer was: ${fullName}`, "info", false);
                displayResults(false, fullName, 0, revealedClues.length);
                submitGuessBtn.disabled = true;
                nextClueBtn.disabled = true;
                return;
            }

            if (currentClueIndex >= 4) return; // Already at max clues
            const nextClueText = await fetchNextClue();
            if (nextClueText) {
                currentClueIndex++;
                revealedClues.push(nextClueText);
                renderCluesList();
                updateStarPotential();
                updateNextClueButton();
                updateRevealButton();
                saveGameState();
                if (currentClueIndex === 2 && !geminiClueUsed) {
                    geminiClueBtn.classList.remove('hidden');
                }
            }
        }
    
        async function handleGuess() {
            if (gameEnded) return;
    
            const { guessedFirstName, guessedLastName } = getGuessedName();
            if (!guessedFirstName || (currentChallenge.lastNameLength > 0 && !guessedLastName)) {
                showFeedback("Please fill in all letters.", "error");
                return;
            }
    
            const result = await submitGuess(guessedFirstName, guessedLastName);
            if (result.correct) {
                correctGuess(result.fullName);
            } else {
                incorrectGuess();
            }
        }
    
        // --- Event Listeners ---
        submitGuessBtn.addEventListener('click', handleGuess);
        nextClueBtn.addEventListener('click', handleNextClue);
        document.getElementById('reveal-letter-btn').addEventListener('click', revealRandomLetter);
    
        // --- Start Game ---
        showWelcomeScreen();

        // Add the cryptic clue button to the DOM
        geminiClueBtn = document.getElementById('gemini-clue-btn');

        // Handle clicking the cryptic clue button
        if (geminiClueBtn) {
            geminiClueBtn.addEventListener('click', async () => {
                geminiClueBtn.disabled = true;
                geminiClueBtn.textContent = 'Loading cryptic clue...';
                try {
                    const response = await fetch('/api/cryptic-clue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_id: currentChallenge.player_id })
                    });
                    const data = await response.json();
                    if (data.clue) {
                        // Deduct 2 stars: add a dummy clue, then the cryptic clue
                        revealedClues.push("Gemini penalty (used cryptic clue)");
                        crypticClueText = data.clue;
                        revealedClues.push(`Cryptic Clue: ${crypticClueText}`);
                        renderCluesList();
                        geminiClueUsed = true;
                        updateStarPotential();
                        updateNextClueButton();
                        updateRevealButton();
                        saveGameState();
                        geminiClueBtn.classList.add('hidden');
                    } else {
                        clueTextEl.textContent = data.error || 'Could not get cryptic clue.';
                        geminiClueBtn.disabled = false;
                        geminiClueBtn.textContent = 'Get Cryptic Clue (Lose 2 ‚≠ê)';
                    }
                } catch (err) {
                    clueTextEl.textContent = 'Error getting cryptic clue.';
                    geminiClueBtn.disabled = false;
                    geminiClueBtn.textContent = 'Get Cryptic Clue (Lose 2 ‚≠ê)';
                }
            });
        }

        // Handle the player bio feature
        if (generateBioBtn) {
            generateBioBtn.addEventListener('click', async () => {
                bioContainer.classList.remove('hidden');
                bioLoading.style.display = 'flex';
                bioContent.textContent = '';
                try {
                    const response = await fetch('/api/player-bio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_id: currentChallenge.player_id })
                    });
                    const data = await response.json();
                    bioLoading.style.display = 'none';
                    if (data.bio) {
                        bioContent.textContent = data.bio;
                    } else {
                        bioContent.textContent = data.error || 'Could not generate player bio.';
                    }
                } catch (err) {
                    bioLoading.style.display = 'none';
                    bioContent.textContent = 'Error generating player bio.';
                }
            });
        }

        // Show the Change Player button if running locally
        fetch('/api/config')
          .then(res => res.json())
          .then(cfg => {
            if (cfg.isLocal) {
              document.getElementById('change-player-btn').style.display = 'block';
            }
          });

        // When Change Player is clicked, pick a random player and set it
        const changeBtn = document.getElementById('change-player-btn');
        if (changeBtn) {
          changeBtn.addEventListener('click', function() {
            // For now, hardcode 163 as the number of players (or update if needed)
            const randomIdx = Math.floor(Math.random() * 163);
            fetch('/api/set-player', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({player_id: randomIdx})
            }).then(res => res.json())
              .then(data => {
                if (data.success) {
                  clearGameState();
                  // Remove today's completed game from stats so the new player starts fresh
                  const stats = JSON.parse(localStorage.getItem(STATS_KEY));
                  if (stats && stats.games) {
                    const today = new Date().toISOString().split('T')[0];
                    stats.games = stats.games.filter(g => g.date !== today);
                    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
                  }
                  window.location.reload();
                } else {
                  alert('Failed to change player');
                }
              });
          });
        }

        // --- Welcome Screen ---
        async function showWelcomeScreen() {
            const stats = JSON.parse(localStorage.getItem(STATS_KEY));
            const today = new Date().toISOString().split('T')[0];
            const todayGame = stats && stats.games && stats.games.find(game => game.date === today);

            if (todayGame) {
                // Already played today ‚Äî fetch challenge to get player name, then show results
                clearGameState();
                const challengeData = await fetchDailyChallenge();
                if (challengeData) {
                    currentChallenge = challengeData;
                    const fullName = `${challengeData.firstName} ${challengeData.lastName}`.trim();
                    const starsEarned = todayGame.stars;
                    gameEnded = true;
                    displayResults(starsEarned > 0, fullName, starsEarned, null);
                }
                return;
            }

            // Check for saved in-progress game state
            const savedState = loadGameState();
            if (savedState) {
                restoreGame(savedState);
                return;
            }

            // Show welcome view with streak
            const welcomeView = document.getElementById('welcome-view');
            const streakValue = document.getElementById('streak-value');
            const streakLabel = document.getElementById('streak-label');
            const streak = (stats && stats.currentStreak) || 0;

            if (streak > 0) {
                streakValue.textContent = `${streak} üî•`;
                streakLabel.textContent = streak === 1 ? 'Day Streak' : 'Day Streak';
            } else {
                streakValue.textContent = '0 üî•';
                streakLabel.textContent = 'Start a new streak today!';
            }

            welcomeView.classList.remove('hidden');
            gameView.classList.add('hidden');
            resultsView.classList.add('hidden');
        }

        document.getElementById('play-btn').addEventListener('click', () => {
            document.getElementById('welcome-view').classList.add('hidden');
            initializeGame();
        });

        // --- Stats Management ---
        function initializeStats() {
            const stats = localStorage.getItem(STATS_KEY);
            if (!stats) {
                const initialStats = {
                    games: [],
                    currentStreak: 0,
                    longestStreak: 0,
                    totalStars: 0,
                    gamesPlayed: 0,
                    starDistribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
                };
                localStorage.setItem(STATS_KEY, JSON.stringify(initialStats));
                return initialStats;
            }
            return JSON.parse(stats);
        }

        function saveGameResult(stars, override = false) {
            initializeStats(); // Ensure stats are initialized
            const stats = JSON.parse(localStorage.getItem(STATS_KEY));
            const today = new Date().toISOString().split('T')[0];
            
            // Only prevent multiple plays if not in local mode or override is false
            const playedToday = stats.games.some(game => game.date === today);
            if (playedToday && !override) return;

            // Add new game result
            stats.games.push({
                date: today,
                stars: stars
            });

            // Update totals
            stats.totalStars += stars;
            stats.gamesPlayed += 1;
            stats.starDistribution[stars] += 1;

            // Calculate streak
            const sortedGames = [...stats.games].sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < sortedGames.length; i++) {
                const gameDate = new Date(sortedGames[i].date);
                const daysDiff = Math.floor((currentDate - gameDate) / (1000 * 60 * 60 * 24));
                
                if (i === 0 && daysDiff > 1) {
                    // If there's a gap between today and the last game, streak is 0
                    streak = 0;
                    break;
                }
                
                if (i > 0) {
                    const prevGameDate = new Date(sortedGames[i-1].date);
                    const daysBetweenGames = Math.floor((prevGameDate - gameDate) / (1000 * 60 * 60 * 24));
                    if (daysBetweenGames > 1) break;
                }
                
                streak++;
                currentDate = gameDate;
            }
            
            stats.currentStreak = streak;
            if (!stats.longestStreak || streak > stats.longestStreak) {
                stats.longestStreak = streak;
            }
            localStorage.setItem(STATS_KEY, JSON.stringify(stats));
        }

        function updateStatsDisplay() {
            const stats = JSON.parse(localStorage.getItem(STATS_KEY));
            
            // Update star distribution bars and counts
            const totalGames = stats.gamesPlayed;
            for (let i = 1; i <= 5; i++) {
                const count = stats.starDistribution[i];
                const percentage = totalGames > 0 ? (count / totalGames) * 100 : 0;
                document.getElementById(`star-${i}-bar`).style.width = `${percentage}%`;
                document.getElementById(`star-${i}-count`).textContent = count;
            }
            
            // Update other stats
            document.getElementById('total-stars-stat').textContent = `${stats.totalStars} ‚≠ê`;
            document.getElementById('games-played-stat').textContent = stats.gamesPlayed;
            document.getElementById('current-streak-stat').textContent = `${stats.currentStreak} üî•`;
            document.getElementById('longest-streak-stat').textContent = `${stats.longestStreak || 0} üî•`;
        }

        // --- Event Listeners ---
        document.getElementById('view-stats-btn').addEventListener('click', () => {
            gameView.classList.add('hidden');
            resultsView.classList.add('hidden');
            document.getElementById('stats-view').classList.remove('hidden');
            updateStatsDisplay();
            document.getElementById('view-stats-btn').style.display = 'none';
        });

        document.getElementById('back-to-game-btn-stats').addEventListener('click', () => {
            document.getElementById('stats-view').classList.add('hidden');
            if (gameEnded) {
                resultsView.classList.remove('hidden');
            } else {
                gameView.classList.remove('hidden');
            }
            document.getElementById('view-stats-btn').style.display = '';
        });

        // --- Live Countdown Timer ---
        function updateCountdown() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setHours(24, 0, 0, 0); // Midnight next day
            let diff = tomorrow - now;
            let totalSeconds = Math.floor(diff / 1000);
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);

        function renderCluesList() {
            const cluesListEl = document.getElementById('clues-list');
            cluesListEl.innerHTML = '';
            // Filter out dummy penalty entries
            const visibleClues = revealedClues.filter(clue => clue !== 'Gemini penalty (used cryptic clue)' && clue !== 'Letter reveal penalty');
            visibleClues.forEach((clue, idx) => {
                const clueDiv = document.createElement('div');
                const isNewest = idx === visibleClues.length - 1 && visibleClues.length > 1;
                clueDiv.className = 'mb-2' + (isNewest ? ' clue-new' : '');
                clueDiv.innerHTML = `<span class="font-semibold text-sky-700">Clue ${idx + 1}/5:</span> <span class="text-sky-800">${clue}</span>`;
                cluesListEl.appendChild(clueDiv);
            });
        }

        function updateNextClueButton() {
            if (!nextClueBtn) return;
            const currentStars = Math.max(6 - revealedClues.length, 1);
            // Show "Give Up" when at 1 star or all 5 clue slots used
            if (currentStars === 1 || currentClueIndex >= 4) {
                nextClueBtn.textContent = "Give Up";
            } else {
                const nextStars = Math.max(currentStars - 1, 1);
                nextClueBtn.innerHTML = `<span class=\"material-icons\">arrow_forward</span> Next Clue (${nextStars} <span class=\"star\">‚≠ê</span>)`;
            }
            console.log('updateNextClueButton called. Button disabled:', nextClueBtn.disabled, 'Label:', nextClueBtn.innerHTML || nextClueBtn.textContent);
        }

        // --- Share Results ---
        const shareModal = document.getElementById('share-modal');
        const shareTextDisplay = document.getElementById('share-text-display');
        const copyToClipboardBtn = document.getElementById('copy-to-clipboard-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const closeShareModalBtn = document.getElementById('close-share-modal-btn');
        const shareResultsBtn = document.getElementById('share-results-btn');

        function getShareText() {
            const stats = JSON.parse(localStorage.getItem(STATS_KEY));
            const today = new Date().toISOString().split('T')[0];
            const todayGame = stats && stats.games && stats.games.find(game => game.date === today);
            const stars = todayGame ? todayGame.stars : 0;
            const dateStr = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            const starEmojis = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
            const revealCount = revealedLetterPositions.length;
            const revealText = revealCount > 0 ? ` (${revealCount}üí°)` : '';
            return `Brighton Player Daily - ${stars}/5 ‚≠ê${revealText}\n${dateStr}\n${starEmojis}\nhttps://brighton-daily.fly.dev`;
        }

        function openShareModal() {
            const text = getShareText();
            shareTextDisplay.textContent = text;
            copyFeedback.textContent = '';

            // Update Twitter/X link
            const twitterLink = shareModal.querySelector('a[class*="1DA1F2"]');
            if (twitterLink) {
                twitterLink.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            }

            // Update WhatsApp link
            const whatsappLink = shareModal.querySelector('a[class*="25D366"]');
            if (whatsappLink) {
                whatsappLink.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
            }

            shareModal.classList.remove('hidden');
        }

        shareResultsBtn.addEventListener('click', openShareModal);

        closeShareModalBtn.addEventListener('click', () => {
            shareModal.classList.add('hidden');
        });

        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.classList.add('hidden');
            }
        });

        copyToClipboardBtn.addEventListener('click', async () => {
            const text = getShareText();
            try {
                await navigator.clipboard.writeText(text);
                copyFeedback.textContent = 'Copied to clipboard!';
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                copyFeedback.textContent = 'Copied to clipboard!';
            }
            setTimeout(() => { copyFeedback.textContent = ''; }, 3000);
        });
    </script>
</body>
</html>